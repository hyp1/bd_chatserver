<!doctype html>
<html>
  <head>
    <title>BD CMS Chat</title>
    <style>
    
      .container {
    width: 80%;
    height: 100%;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
}

header {
    flex-shrink: 0;

}
.body{
    flex-grow: 1;
    overflow: auto;
    min-height: 2em;
}
footer{
    flex-shrink: 0;
    background: #34495e;
    position: fixed;
    left: 0;
    bottom: 0;
    width:100;
}
h1{
  background: #34495e;
  font-size: 2.4em;
  text-align:center;
  color: #eee; 
}
.selected {
background: rgb(170, 218, 255) !important;
    }
#messages {
  width:80%;
  float:left;
  list-style-type: none;
}
#users {
  margin:auto;
  width:18%;
  float:right;
  top:0;
  height:100%;
  list-style-type: none;
}
  </style>
    <script src="//cdn.bootcss.com/socket.io/2.1.0/socket.io.dev.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
  </head> 
  <div class="container">
      <header><h1 id="user">tesssst</h1></header>
      <div class="body">
        <div>
          <ul id="messages"></ul>
        </div>
          <div>
              <ul id="users"></ul>
          </div>
          
        </div>
      <footer>

          <form action="">
              <input id="message" autocomplete="off" /><button id="bmessage">Send</button>
              <input id="name" autocomplete="off" value="nick" disabled/><button id="bpriv">PrivatMsg</button>
            </form>

      </footer>
  </div>







  </html>
 <script>

     var socket; 
     var name=getURLParameter('name');
      $(function () {
        $('#name').val(name);
        $('#user').text(name);
});

/*
socket = io.connect( 'https://test.com:33333' );
socket = io.connect( 'ws://test.com' );
socket = io.connect( 'wss://test.com' );      
*/

socket = io.connect( );

socket.emit('connection name',{'name':name});

socket.on('message', function(msg){
          console.log(msg);
         // console.log(socket.handshake.headers.host.split(":").shift());
          $('#messages').append($('<li>').html(getFormattedDate(msg.time)+' '+msg.msg));
          window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('private message', function(msg){
    //      console.log(socket.handshake.headers.host.split(":").shift());
          $('#messages').append($('<li>').html(getFormattedDate(msg.time)+' '+msg.tag+msg.txt));
          window.scrollTo(0, document.body.scrollHeight);
});


socket.on('new user', function(msg){
    //      console.log(socket.handshake.headers.host.split(":").shift());
          $('#messages').append($('<li>').html(msg));
          window.scrollTo(0, document.body.scrollHeight);
});



socket.on('userlist', function(users){
   //      console.log(socket.handshake.headers.host.split(":").shift());
   var cnt=0;
   $('#users').empty();
  users.forEach(user=> {
     $('#users').append($('<li id="'+cnt+'" onclick="setPriv(this);">').html(''+user.name+''));
        cnt++;
});

});


$('#bmessage').click(function(){
  if($('#message').val().length<3)return false;
         socket.emit('message',  $('#user').text()+':'+$('#message').val());
          $('#message').val('' );
          $('#message').focus();
          return false;
 });

 $('#bpriv').click(function(){
  if($('#message').val().length<3)return false;
          var message = {time:0,to: $('#name').val(), txt: $('#user').text()+':'+$('#message').val()};
          console.log(message);
          socket.emit('private message', message); 
          $('#message').val('');
          $('#message').focus();  
          return false;       
});



function setPriv(div){
    $('#name').val(div.innerHTML);
    $('#users li').removeClass('selected');
    $('li[id='+div.id+']').addClass('selected');
    $('#message').focus();  
};


// RegEx: http://stackoverflow.com/a/1404100/451634
function getURLParameter(name) {
    var value = decodeURIComponent((RegExp(name + '=' + '(.+?)(&|$)').exec(location.search) || [, ""])[1]);
  return (value !== 'null') ? value : false;
}

function getFormattedDate(time) {
    var date = new Date(time);

    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var min = date.getMinutes();
    var sec = date.getSeconds();

    month = (month < 10 ? "0" : "") + month;
    day = (day < 10 ? "0" : "") + day;
    hour = (hour < 10 ? "0" : "") + hour;
    min = (min < 10 ? "0" : "") + min;
    sec = (sec < 10 ? "0" : "") + sec;

    var str =  day + "."+ month + "."  +date.getFullYear() + " " +  hour + ":" + min + ":" + sec;

    /*alert(str);*/

    return str;
}

</script>
